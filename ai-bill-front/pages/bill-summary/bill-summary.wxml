<!--pages/bill-summary/bill-summary.wxml-->
<view class="container">
  <!-- æœˆä»½é€‰æ‹©å™¨å’Œæ€»è§ˆ -->
  <view class="summary-header">
    <view class="month-selector">
      <picker mode="selector" 
              range="{{monthPickerRange}}" 
              range-key="text" 
              value="{{monthPickerIndex}}" 
              bindchange="onMonthPickerChange">
        <view class="month-text">{{currentYear}}å¹´{{currentMonth}}æœˆç»Ÿè®¡ ğŸ“…</view>
      </picker>
      <text class="month-tip">ç‚¹å‡»é€‰æ‹©æœˆä»½</text>
    </view>
    <view class="summary-overview">
      <view class="overview-item expense">
        <text class="label">æ€»æ”¯å‡º</text>
        <text class="amount">Â¥{{totalExpense}}</text>
      </view>
      <view class="overview-item income">
        <text class="label">æ€»æ”¶å…¥</text>
        <text class="amount">Â¥{{totalIncome}}</text>
      </view>
      <view class="overview-item balance">
        <text class="label">ç»“ä½™</text>
        <text class="amount {{balanceType}}">
          Â¥{{balance}}
        </text>
      </view>
    </view>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{isLoading}}" class="loading-container">
    <text class="loading-text">æ­£åœ¨åŠ è½½ç»Ÿè®¡æ•°æ®...</text>
  </view>

  <!-- å›¾è¡¨å†…å®¹ -->
  <view wx:else class="charts-container">
    <!-- æœˆåº¦æ”¶æ”¯ç»Ÿè®¡ (CSS æŸ±çŠ¶å›¾) -->
    <view class="chart-section">
      <view class="chart-title">æœˆåº¦æ”¶æ”¯ç»Ÿè®¡</view>
      <view class="bar-chart-container">
        <view class="bar-chart-wrapper">
          <!-- Yè½´æ ‡ç­¾ -->
          <view class="y-axis">
            <view class="y-axis-label" wx:for="{{yAxisLabels}}" wx:key="index">
              Â¥{{item}}
            </view>
          </view>
          <!-- æŸ±çŠ¶å›¾ä¸»ä½“ -->
          <view class="bars-container">
            <view class="bar-item" wx:for="{{chartDays}}" wx:key="index" wx:if="{{item.show}}">
              <view class="bar-group">
                <!-- æ”¶å…¥æŸ± -->
                <view class="bar bar-income" 
                      style="height: {{item.incomeHeight}}%;"></view>
                <!-- æ”¯å‡ºæŸ± -->
                <view class="bar bar-expense" 
                      style="height: {{item.expenseHeight}}%;"></view>
              </view>
              <view class="bar-label">{{item.day}}æ—¥</view>
            </view>
          </view>
        </view>
        <!-- å›¾ä¾‹ -->
        <view class="legend">
          <view class="legend-item">
            <view class="legend-color legend-income"></view>
            <text>æ”¶å…¥</text>
          </view>
          <view class="legend-item">
            <view class="legend-color legend-expense"></view>
            <text>æ”¯å‡º</text>
          </view>
        </view>
      </view>
    </view>

    <!-- åˆ†ç±»å æ¯” (CSS é¥¼å›¾) -->
    <view class="chart-section">
      <view class="chart-title">åˆ†ç±»å æ¯”</view>
      <view class="pie-chart-controls">
        <button bindtap="onPieChartTypeChange" data-type="expense" 
                class="control-btn {{ pieChartType === 'expense' ? 'active' : '' }}">
          æ”¯å‡ºåˆ†æ
        </button>
        <button bindtap="onPieChartTypeChange" data-type="income" 
                class="control-btn {{ pieChartType === 'income' ? 'active' : '' }}">
          æ”¶å…¥åˆ†æ
        </button>
      </view>
      
      <!-- é¥¼å›¾å®¹å™¨ -->
      <view class="pie-chart-container">
        <view class="pie-chart-wrapper">
          <!-- åœ†å½¢å›¾è¡¨ -->
          <view class="pie-chart" style="background: conic-gradient({{pieChartGradient}});">
            <view class="pie-chart-center">
              <view class="pie-center-label">
                {{ pieChartType === 'expense' ? 'æ€»æ”¯å‡º' : 'æ€»æ”¶å…¥' }}
              </view>
              <view class="pie-center-amount">
                Â¥{{ pieChartType === 'expense' ? totalExpense : totalIncome }}
              </view>
            </view>
          </view>
          
          <!-- å›¾ä¾‹ -->
          <view class="pie-legend">
            <view class="pie-legend-item" wx:for="{{currentCategoriesData}}" wx:key="name">
              <view class="pie-legend-color" style="background-color: {{item.color}};"></view>
              <view class="pie-legend-text">
                <text class="pie-legend-name">{{item.name}}</text>
                <text class="pie-legend-value">Â¥{{item.value}} ({{item.percentage}}%)</text>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>
    
    <!-- è´¦å•åˆ—è¡¨ -->
    <view class="bill-list-section">
      <view class="section-header">
        <view class="section-title">è´¦å•æ˜ç»†</view>
      </view>
      
      <view class="bill-list">
        <view wx:if="{{!billsData || billsData.length === 0}}" class="no-data">
          <text>æš‚æ— è´¦å•æ•°æ®</text>
        </view>
        
        <block wx:else>
          <view wx:for="{{billsData}}" wx:key="id" class="bill-item">
            <view class="bill-content" bindtap="onBillItemTap" data-id="{{item.id}}">
              <view class="bill-left">
                <view class="bill-type {{item.transactionType === 'expense' ? 'expense-type' : 'income-type'}}">
                  {{item.billType || 'å…¶ä»–'}}
                </view>
                <view class="bill-time">{{item.transactionDate || 'æœªçŸ¥æ—¥æœŸ'}}</view>
              </view>
              <view class="bill-right">
                <view class="bill-amount {{item.transactionType === 'expense' ? 'expense-amount' : 'income-amount'}}">
                  {{item.transactionType === 'expense' ? '-' : '+'}}Â¥{{item.totalAmount}}
                </view>
                <view class="bill-actions">
                  <button class="action-btn edit-btn" bindtap="onEditBillTap" data-id="{{item.id}}">ç¼–è¾‘</button>
                </view>
              </view>
            </view>
          </view>
        </block>
      </view>
      
      <!-- åŠ è½½æ›´å¤š -->
      <view wx:if="{{billsData && billsData.length > 0}}" class="load-more">
        <button class="load-more-btn" bindtap="loadMoreBills">æŸ¥çœ‹æ›´å¤š</button>
      </view>
    </view>
  </view>
</view>