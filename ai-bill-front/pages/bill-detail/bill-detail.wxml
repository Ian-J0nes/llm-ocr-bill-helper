<view class="container">
  <!-- åŠ è½½ä¸­çŠ¶æ€ -->
  <view class="loading-container" wx:if="{{isLoading}}">
    <view class="loading-text">åŠ è½½ä¸­...</view>
  </view>

  <!-- è´¦å•è¯¦æƒ…å†…å®¹ -->
  <view class="bill-detail-container" wx:if="{{!isLoading && billDetail}}">
    <!-- æ˜¾ç¤ºæ¨¡å¼ -->
    <block wx:if="{{!isEditing}}">
      <!-- é‡‘é¢åŒºåŸŸ -->
      <view class="amount-section">
        <view class="amount-label">{{billDetail.transactionType === 'expense' ? 'æ”¯å‡º' : 'æ”¶å…¥'}}</view>
        <view class="amount-value {{billDetail.transactionType}}">
          {{billDetail.transactionType === 'expense' ? '-' : '+'}}{{billDetail.totalAmount}}
        </view>
        <view class="currency">{{billDetail.currencyCode || 'CNY'}}</view>
      </view>

      <!-- åŸºæœ¬ä¿¡æ¯åŒºåŸŸ -->
      <view class="info-section">
        <view class="info-title">è´¦å•ä¿¡æ¯</view>
        
        <view class="info-item">
          <view class="info-label">è´¦å•åç§°</view>
          <view class="info-value">{{billDetail.name || 'æ— '}}</view>
        </view>
        
        <view class="info-item">
          <view class="info-label">è´¦å•ç±»å‹</view>
          <view class="info-value">{{billDetail.billType || 'å…¶ä»–'}}</view>
        </view>
        
        <view class="info-item">
          <view class="info-label">äº¤æ˜“æ—¥æœŸ</view>
          <view class="info-value">{{billDetail.issueDate}}</view>
        </view>
        
        <view class="info-item" wx:if="{{billDetail.supplierName}}">
          <view class="info-label">{{billDetail.transactionType === 'expense' ? 'æ”¶æ¬¾æ–¹' : 'ä»˜æ¬¾æ–¹'}}</view>
          <view class="info-value">{{billDetail.supplierName}}</view>
        </view>
        
        <view class="info-item" wx:if="{{billDetail.invoiceNumber}}">
          <view class="info-label">å‘ç¥¨å·ç </view>
          <view class="info-value">{{billDetail.invoiceNumber}}</view>
        </view>
        
        <view class="info-item" wx:if="{{billDetail.taxAmount}}">
          <view class="info-label">ç¨é¢</view>
          <view class="info-value">{{billDetail.taxAmount}}</view>
        </view>
        
        <view class="info-item" wx:if="{{billDetail.notes}}">
          <view class="info-label">å¤‡æ³¨</view>
          <view class="info-value">{{billDetail.notes}}</view>
        </view>
      </view>

      <!-- ç¥¨æ®å›¾ç‰‡åŒºåŸŸ -->
      <view class="image-section" wx:if="{{billImage.imageUrl}}">
        <view class="image-title">ç¥¨æ®å›¾ç‰‡</view>
        <button 
          class="view-image-btn" 
          bindtap="previewImage" 
          data-url="{{billImage.imageUrl}}"
        >
          <view class="btn-icon">ğŸ‘ï¸</view>
          <view class="btn-text">æŸ¥çœ‹ç¥¨æ®å›¾ç‰‡</view>
          <view class="image-info">
            <text class="image-name">{{billImage.fileName}}</text>
            <text class="image-size">{{billImage.fileSize}}</text>
          </view>
        </button>
      </view>

      <!-- æ“ä½œæŒ‰é’®åŒºåŸŸ -->
      <view class="action-section">
        <button class="action-btn edit-btn" bindtap="onEditTap">ç¼–è¾‘è´¦å•</button>
        <button class="action-btn delete-btn" bindtap="deleteBill">åˆ é™¤è´¦å•</button>
      </view>
    </block>

    <!-- ç¼–è¾‘æ¨¡å¼ -->
    <block wx:else>
      <view class="edit-header">
        <view class="edit-title">ç¼–è¾‘è´¦å•</view>
      </view>

      <view class="edit-form">
        <!-- äº¤æ˜“ç±»å‹é€‰æ‹© -->
        <view class="form-item">
          <view class="form-label">äº¤æ˜“ç±»å‹</view>
          <view class="form-input">
            <picker mode="selector" range="{{transactionTypeOptions}}" range-key="name" 
                    value="{{billDetailEditable.transactionType === 'expense' ? 0 : 1}}" 
                    bindchange="onTransactionTypeChange">
              <view class="picker-value {{billDetailEditable.transactionType === 'expense' ? 'expense' : 'income'}}">
                {{billDetailEditable.transactionType === 'expense' ? 'æ”¯å‡º' : 'æ”¶å…¥'}}
                <text class="picker-arrow">â–¼</text>
              </view>
            </picker>
          </view>
        </view>
        
        <!-- é‡‘é¢ -->
        <view class="form-item">
          <view class="form-label">é‡‘é¢</view>
          <view class="form-input">
            <input class="input-field" type="digit" value="{{billDetailEditable.totalAmount}}" bindinput="onAmountInput" placeholder="è¯·è¾“å…¥é‡‘é¢"/>
          </view>
        </view>
        
        <!-- è´¦å•åç§° -->
        <view class="form-item">
          <view class="form-label">è´¦å•åç§°</view>
          <view class="form-input">
            <input class="input-field" value="{{billDetailEditable.name}}" bindinput="onNameInput" placeholder="è¯·è¾“å…¥åç§°"/>
          </view>
        </view>
        
        <!-- è´¦å•ç±»å‹ -->
        <view class="form-item">
          <view class="form-label">è´¦å•ç±»å‹</view>
          <view class="form-input">
            <picker mode="selector" range="{{billTypeOptions}}" 
                    value="{{billTypeOptions.indexOf(billDetailEditable.billType)}}" 
                    bindchange="onBillTypeChange">
              <view class="picker-value">
                {{billDetailEditable.billType || 'è¯·é€‰æ‹©ç±»å‹'}}
                <text class="picker-arrow">â–¼</text>
              </view>
            </picker>
          </view>
        </view>
        
        <!-- äº¤æ˜“æ—¥æœŸ -->
        <view class="form-item">
          <view class="form-label">äº¤æ˜“æ—¥æœŸ</view>
          <view class="form-input">
            <picker mode="date" value="{{datePickerValue}}" start="2000-01-01" end="{{today}}" bindchange="onDateChange">
              <view class="picker-value">
                {{billDetailEditable.issueDate || 'è¯·é€‰æ‹©æ—¥æœŸ'}}
                <text class="picker-arrow">â–¼</text>
              </view>
            </picker>
          </view>
        </view>
        
        <!-- æ”¶æ¬¾æ–¹/ä»˜æ¬¾æ–¹ -->
        <view class="form-item">
          <view class="form-label">{{billDetailEditable.transactionType === 'expense' ? 'æ”¶æ¬¾æ–¹' : 'ä»˜æ¬¾æ–¹'}}</view>
          <view class="form-input">
            <input class="input-field" value="{{billDetailEditable.supplierName}}" bindinput="onSupplierInput" placeholder="è¯·è¾“å…¥åç§°ï¼ˆé€‰å¡«ï¼‰"/>
          </view>
        </view>
        
        <!-- å‘ç¥¨å·ç  -->
        <view class="form-item">
          <view class="form-label">å‘ç¥¨å·ç </view>
          <view class="form-input">
            <input class="input-field" value="{{billDetailEditable.invoiceNumber}}" bindinput="onInvoiceNumberInput" placeholder="è¯·è¾“å…¥å‘ç¥¨å·ï¼ˆé€‰å¡«ï¼‰"/>
          </view>
        </view>
        
        <!-- ç¨é¢ -->
        <view class="form-item">
          <view class="form-label">ç¨é¢</view>
          <view class="form-input">
            <input class="input-field" type="digit" value="{{billDetailEditable.taxAmount}}" bindinput="onTaxInput" placeholder="è¯·è¾“å…¥ç¨é¢ï¼ˆé€‰å¡«ï¼‰"/>
          </view>
        </view>
        
        <!-- å¤‡æ³¨ -->
        <view class="form-item form-item-textarea">
          <view class="form-label">å¤‡æ³¨</view>
          <view class="form-input">
            <textarea class="textarea-field" value="{{billDetailEditable.notes}}" bindinput="onNotesInput" placeholder="è¯·è¾“å…¥å¤‡æ³¨ï¼ˆé€‰å¡«ï¼‰" maxlength="200"/>
          </view>
        </view>
      </view>

      <!-- ç¼–è¾‘æ¨¡å¼åº•éƒ¨æŒ‰é’® -->
      <view class="edit-action-section">
        <button class="action-btn cancel-btn" bindtap="cancelEdit" disabled="{{isSubmitting}}">å–æ¶ˆ</button>
        <button class="action-btn save-btn" bindtap="saveEdit" disabled="{{isSubmitting}}">
          {{isSubmitting ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜'}}
        </button>
      </view>
    </block>
  </view>

  <!-- é”™è¯¯çŠ¶æ€ -->
  <view class="error-container" wx:if="{{!isLoading && !billDetail}}">
    <view class="error-text">è´¦å•ä¿¡æ¯åŠ è½½å¤±è´¥</view>
    <button class="retry-btn" bindtap="loadBillDetail">é‡è¯•</button>
  </view>
</view> 