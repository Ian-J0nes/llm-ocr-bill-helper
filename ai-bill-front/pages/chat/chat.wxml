<view class="page-container {{messages.length === 0 ? 'initial-state' : 'chat-state'}}">
  <!-- Initial View: When no messages -->
  <view wx:if="{{messages.length === 0}}" class="initial-view">
    <view class="initial-prompt">
      <image class="initial-avatar" src="/static/icons/xiaomie_avatar.png" mode="aspectFit"></image>
      <text class="prompt-title">ä½ å¥½{{userInfo.nickName || 'æœ‹å‹'}}ï¼Œæˆ‘æ˜¯å°å’©ï¼</text>
      <text class="prompt-subtitle">å¯ä»¥å‘é€æ–‡å­—ä¸æˆ‘èŠå¤©ï¼Œæˆ–è€…ä¸Šä¼ è´¦å•å›¾ç‰‡è®©æˆ‘è¯†åˆ«å“¦~</text>
    </view>
    <view class="initial-input-area-wrapper">
      <view class="shared-input-area">
        <textarea class="shared-message-input"
                  value="{{inputMessage}}"
                  bindinput="onInputChange"
                  placeholder="è¯·è¾“å…¥æ¶ˆæ¯æˆ–é€‰æ‹©å›¾ç‰‡..."
                  auto-height
                  maxlength="-1"
                  show-confirm-bar="{{false}}"
                  cursor-spacing="20"
                  />
        <view class="shared-input-buttons">
          <image class="shared-upload-btn" src="/static/icons/uploadbutton.png" mode="aspectFit" bindtap="chooseImageAndSend"/>
          <image class="shared-send-btn" src="/static/icons/arrow.png" mode="aspectFit" bindtap="sendTextMessage"/>
        </view>
      </view>
    </view>
  </view>

  <!-- Chat View: When there are messages -->
  <block wx:else>
    <scroll-view scroll-y="true" class="chat-list" scroll-into-view="{{scrollToMessageId}}" scroll-with-animation="true">
      <block wx:for="{{messages}}" wx:key="id" wx:for-item="item" wx:for-index="index">
        <view id="{{item.id}}" class="message-item-wrapper">
          <view class="message-item {{item.type === 'user' ? 'user-message' : 'system-message'}}">
            <!-- Avatar (Optional, add if you have avatars per message type) -->
            <!-- 
            <image wx:if="{{item.type === 'user'}}" class="message-avatar user-avatar" src="{{userInfo.avatarUrl}}"></image>
            <image wx:if="{{item.type === 'system'}}" class="message-avatar system-avatar" src="/static/icons/xiaomie_avatar.png"></image>
            -->
            <view class="message-content-container">
              <view class="message-content">
                <!-- Plain Text Content -->
                <text wx:if="{{item.isText && !item.isBill && item.content}}">{{item.content}}</text>
                
                <!-- User Image -->
                <image wx:if="{{item.type === 'user' && (item.localImagePath || item.imageUrl) && !item.error}}" 
                       class="message-image" 
                       src="{{item.uploading && item.localImagePath ? item.localImagePath : (item.imageUrl || item.localImagePath)}}" 
                       mode="widthFix" 
                       bindtap="previewImage" 
                       data-url="{{item.imageUrl || item.localImagePath}}"/>
                
                <!-- System Image (e.g., if AI sends an image not related to bill) -->
                <image wx:if="{{item.type === 'system' && !item.isBill && item.imageUrl}}" class="message-image" src="{{item.imageUrl}}" mode="widthFix" bindtap="previewImage" data-url="{{item.imageUrl}}"></image>
                
                <!-- Bill Form / Display -->
                <view wx:if="{{item.type === 'system' && item.isBill && item.billData}}">
                  <view class="bill-form-container">
                    <view class="bill-form-title">è´¦å•è¯¦æƒ… ğŸ‘</view>

                    <!-- Editing State: Input Fields -->
                    <block wx:if="{{item.isEditing}}">
                      <view class="bill-field">
                        <text class="bill-label">åç§°<text class="required-star">*</text>ï¼š</text>
                        <input class="bill-input" value="{{item.billDataEditable.name}}" bindinput="handleBillInputChange" data-field="name" data-index="{{index}}" placeholder="å¦‚ï¼šæ™šé¤ã€è´­ç‰©"/>
                      </view>
                      <view class="bill-field">
                        <text class="bill-label">äº¤æ˜“ç±»å‹<text class="required-star">*</text>ï¼š</text>
                        <picker mode="selector" range="{{transactionTypeOptions}}" range-key="name" value="{{transactionTypeOptions_value_map[item.billDataEditable.transactionType] || 0}}" bindchange="handleTransactionTypeChange" data-index="{{index}}">
                            <view class="bill-input picker-input">{{item.billDataEditable.transactionType ? (transactionTypeOptions_value_map[item.billDataEditable.transactionType] !== undefined ? transactionTypeOptions[transactionTypeOptions_value_map[item.billDataEditable.transactionType]].name : 'è¯·é€‰æ‹©') : 'è¯·é€‰æ‹©äº¤æ˜“ç±»å‹'}}</view>
                        </picker>
                      </view>
                      <view class="bill-field">
                        <text class="bill-label">è´¦å•åˆ†ç±»<text class="required-star">*</text>ï¼š</text>
                        <picker mode="selector" range="{{billTypeOptions}}" value="{{billTypeOptions_value_map[item.billDataEditable.billType] || 0}}" bindchange="handleBillTypeChange" data-index="{{index}}">
                           <view class="bill-input picker-input">{{item.billDataEditable.billType || 'è¯·é€‰æ‹©è´¦å•åˆ†ç±»'}}</view>
                        </picker>
                      </view>
                      <view class="bill-field">
                        <text class="bill-label">é‡‘é¢<text class="required-star">*</text>ï¼š</text>
                        <input class="bill-input amount" type="digit" value="{{item.billDataEditable.totalAmount}}" bindinput="handleBillInputChange" data-field="totalAmount" data-index="{{index}}" placeholder="0.00"/>
                      </view>
                       <view class="bill-field">
                        <text class="bill-label">æ—¥æœŸ<text class="required-star">*</text>ï¼š</text>
                        <picker mode="date" value="{{item.billDataEditable.issueDate}}" bindchange="handleBillDateChange" data-index="{{index}}">
                          <view class="bill-input picker-input">{{item.billDataEditable.issueDate_display || item.billDataEditable.issueDate || 'è¯·é€‰æ‹©æ—¥æœŸ'}}</view>
                        </picker>
                      </view>
                      <view class="bill-field">
                        <text class="bill-label">å•†å®¶/æ¥æºï¼š</text>
                        <input class="bill-input" value="{{item.billDataEditable.supplierName}}" bindinput="handleBillInputChange" data-field="supplierName" data-index="{{index}}" placeholder="å¦‚ï¼šæµ·åº•æã€æ”¯ä»˜å®"/>
                      </view>
                      <view class="bill-field">
                        <text class="bill-label">è´§å¸ï¼š</text>
                        <input class="bill-input" value="{{item.billDataEditable.currencyCode || 'CNY'}}" bindinput="handleBillInputChange" data-field="currencyCode" data-index="{{index}}" placeholder="CNY"/>
                      </view>
                      <view class="bill-field">
                        <text class="bill-label">å‘ç¥¨å·ï¼š</text>
                        <input class="bill-input" value="{{item.billDataEditable.invoiceNumber}}" bindinput="handleBillInputChange" data-field="invoiceNumber" data-index="{{index}}" placeholder="å¯é€‰"/>
                      </view>
                      <view class="bill-field">
                        <text class="bill-label">ç¨é¢ï¼š</text>
                        <input class="bill-input" type="digit" value="{{item.billDataEditable.taxAmount}}" bindinput="handleBillInputChange" data-field="taxAmount" data-index="{{index}}" placeholder="å¯é€‰, 0.00"/>
                      </view>
                      <view class="bill-field notes-field">
                        <text class="bill-label">å¤‡æ³¨ï¼š</text>
                        <textarea class="bill-textarea" value="{{item.billDataEditable.notes}}" bindinput="handleBillInputChange" data-field="notes" data-index="{{index}}" auto-height placeholder="å¯é€‰, å¦‚ï¼šå›¢é˜Ÿèšé¤"/>
                      </view>
                    </block>

                    <!-- Non-Editing State: Text Display -->
                    <block wx:else>
                      <view class="bill-field" wx:if="{{item.billData.name}}">
                        <text class="bill-label">åç§°ï¼š</text>
                        <text class="bill-value">{{item.billData.name}}</text>
                      </view>
                      <view class="bill-field" wx:if="{{item.billData.transactionType}}">
                        <text class="bill-label">äº¤æ˜“ç±»å‹ï¼š</text>
                        <text class="bill-value {{item.billData.transactionType === 'income' ? 'income-text' : 'expense-text'}}">{{item.billData.transactionType === 'income' ? 'æ”¶å…¥' : 'æ”¯å‡º'}}</text>
                      </view>
                      <view class="bill-field" wx:if="{{item.billData.billType}}">
                        <text class="bill-label">è´¦å•åˆ†ç±»ï¼š</text>
                        <text class="bill-value">{{item.billData.billType}}</text>
                      </view>
                      <view class="bill-field">
                        <text class="bill-label">é‡‘é¢ï¼š</text>
                        <text class="bill-value amount {{item.billData.transactionType === 'income' ? 'income-text' : 'expense-text'}}">{{item.billData.transactionType === 'income' ? '+' : '-'}}{{item.billData.totalAmount_display || item.billData.totalAmount}} {{item.billData.currencyCode || 'CNY'}}</text>
                      </view>
                      <view class="bill-field" wx:if="{{item.billData.issueDate_display || item.billData.issueDate}}">
                        <text class="bill-label">æ—¥æœŸï¼š</text>
                        <text class="bill-value">{{item.billData.issueDate_display || item.billData.issueDate}}</text>
                      </view>
                      <view class="bill-field" wx:if="{{item.billData.supplierName}}">
                        <text class="bill-label">å•†å®¶/æ¥æºï¼š</text>
                        <text class="bill-value">{{item.billData.supplierName}}</text>
                      </view>
                      <view class="bill-field" wx:if="{{item.billData.invoiceNumber}}">
                        <text class="bill-label">å‘ç¥¨å·ï¼š</text>
                        <text class="bill-value">{{item.billData.invoiceNumber}}</text>
                      </view>
                      <view class="bill-field" wx:if="{{item.billData.taxAmount_display || (item.billData.taxAmount !== null && item.billData.taxAmount !== undefined) }}">
                        <text class="bill-label">ç¨é¢ï¼š</text>
                        <text class="bill-value">{{item.billData.taxAmount_display || item.billData.taxAmount}} {{item.billData.currencyCode || 'CNY'}}</text>
                      </view>
                      <view class="bill-field" wx:if="{{item.billData.items && item.billData.items.length > 0}}">
                        <text class="bill-label">æ˜ç»†ï¼š</text>
                        <block wx:for="{{item.billData.items}}" wx:for-item="subItem" wx:key="index">
                          <text class="bill-value bill-sub-item">- {{subItem.itemName || 'é¡¹ç›®'}} ({{subItem.itemPrice_display || subItem.itemPrice}})</text>
                        </block>
                      </view>
                      <view class="bill-field" wx:if="{{item.billData.notes}}">
                        <text class="bill-label">å¤‡æ³¨ï¼š</text>
                        <text class="bill-value notes-value">{{item.billData.notes}}</text>
                      </view>
                    </block>

                    <!-- Action Buttons -->
                    <view class="bill-actions">
                      <block wx:if="{{item.isEditing}}">
                        <button class="action-btn save-btn" bindtap="handleSaveChangesBill" data-index="{{index}}">ä¿å­˜ä¿®æ”¹</button>
                        <button class="action-btn cancel-btn" bindtap="handleCancelEditBill" data-index="{{index}}">å–æ¶ˆ</button>
                      </block>
                      <block wx:else>
                        <button wx:if="{{!item.alreadySaved}}" class="action-btn confirm-btn" bindtap="handleConfirmSaveBill" data-index="{{index}}">ç¡®è®¤ä¿å­˜</button>
                        <button class="action-btn edit-btn" bindtap="handleEditBill" data-index="{{index}}">ä¿®æ”¹</button>
                        <text wx:if="{{item.alreadySaved}}" class="saved-status">âœ“ å·²ä¿å­˜</text>
                      </block>
                    </view>
                  </view>
                </view>

                <!-- Loading / Status Indicators for AI Message -->
                <view wx:if="{{item.type === 'system' && item.isLoading && !item.isBill}}" class="loading-dots">
                  <text>.</text><text>.</text><text>.</text>
                </view>
              </view> <!-- End .message-content -->

              <!-- Status Indicators for User Message / General Error -->
              <view wx:if="{{item.type === 'user' && item.uploading && !item.error}}" class="message-status user-status">å‘é€ä¸­...</view>
              <view wx:if="{{item.error && item.errorMessage}}" class="message-status error-status">{{item.errorMessage}}</view>
              <view wx:elif="{{item.error && !item.errorMessage}}" class="message-status error-status">{{item.type === 'user' ? 'å‘é€å¤±è´¥' : 'å›å¤å¤„ç†å¤±è´¥'}}</view>
            </view> <!-- End .message-content-container -->
          </view>
        </view>
      </block>
      <view class="scroll-view-bottom-padding"></view> <!-- To ensure last message is not hidden by input area -->
    </scroll-view>

    <!-- Fixed Input Area at the bottom -->
    <view class="chat-input-area-wrapper">
      <view class="shared-input-area">
        <textarea class="shared-message-input"
                  value="{{inputMessage}}"
                  bindinput="onInputChange"
                  placeholder="è·Ÿå°å’©è¯´ç‚¹ä»€ä¹ˆå§..."
                  confirm-type="send"
                  bindconfirm="sendTextMessage"
                  auto-height
                  maxlength="-1"
                  show-confirm-bar="{{false}}"
                  cursor-spacing="20"
                  adjust-position="{{true}}"
                  />
        <view class="shared-input-buttons">
          <image class="shared-upload-btn" src="/static/icons/uploadbutton.png" mode="aspectFit" bindtap="chooseImageAndSend"/>
          <image class="shared-send-btn" src="/static/icons/arrow.png" mode="aspectFit" bindtap="sendTextMessage" />
        </view>
      </view>
    </view>
  </block>
</view>